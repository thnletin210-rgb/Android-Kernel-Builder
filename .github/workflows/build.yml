name: Build Kernel cho Note 11 Pro 4G (Viva) - Android 16

on:
  workflow_dispatch:

jobs:
  build:
    name: Build Kernel Viva
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Builder
        uses: actions/checkout@v4

      - name: Set up Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y git ccache automake flex lzop bison gperf build-essential zip curl zlib1g-dev g++-multilib libxml2-utils bzip2 libbz2-dev libbz2-1.0 libghc-bzlib-dev squashfs-tools pngcrush schedtool dpkg-dev liblz4-tool make optipng maven libssl-dev pwgen libswitch-perl policycoreutils minicom libxml-sax-base-perl libxml-simple-perl bc libc6-dev-i386 lib32ncurses5-dev libx11-dev lib32z-dev libgl1-mesa-dev xsltproc unzip device-tree-compiler python2 python3

      - name: Download Toolchain (Clang 17)
        run: |
          mkdir -p clang
          cd clang
          curl -LO "https://raw.githubusercontent.com/Neutron-Toolchains/clang-build-catalogue/main/neutron-clang-setup.sh"
          bash neutron-clang-setup.sh
          echo "CLANG_DIR=$(pwd)" >> $GITHUB_ENV

      - name: Clone Source Kernel Viva (Base)
        run: |
          # Dung source co ban nhat cua Viva
          git clone --depth=1 https://github.com/xiaomi-mt6781-devs/kernel_xiaomi_viva
      - name: THE MAGIC SCRIPT - Upstream, KSU Next & A16 Patch
        run: |
          cd kernel
          git config --global user.email "bot@viva.com"
          git config --global user.name "VivaBot"

          echo "=========================================="
          echo "1. THU UPSTREAM LEN 4.19.325"
          echo "=========================================="
          git remote add stable https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux-stable.git
          git fetch stable
          # Thu merge, neu loi thi huy merge de giu code sach
          git merge v4.19.325 --no-edit || git merge --abort

          echo "=========================================="
          echo "2. CAI KERNELSU NEXT"
          echo "=========================================="
          curl -LSs "https://raw.githubusercontent.com/rifsytn/KernelSU-Next/main/kernel/setup.sh" | bash -s next

          echo "=========================================="
          echo "3. VA LOI DE BOOT HYPEROS 3 & ANDROID 16"
          echo "=========================================="
          CONF="arch/arm64/configs/viva_defconfig"
          
          # Them flag eBPF (Bat buoc cho Android 16)
          echo "CONFIG_BPF=y" >> $CONF
          echo "CONFIG_BPF_SYSCALL=y" >> $CONF
          echo "CONFIG_BPF_JIT=y" >> $CONF
          echo "CONFIG_HAVE_EBPF_JIT=y" >> $CONF
          echo "CONFIG_NET_CLS_BPF=y" >> $CONF
          echo "CONFIG_NET_ACT_BPF=y" >> $CONF
          echo "CONFIG_BPF_EVENTS=y" >> $CONF
          
          # Them BinderFS (Bat buoc cho HyperOS)
          echo "CONFIG_ANDROID_BINDERFS=y" >> $CONF
          
          # Tat kiem tra bao mat de de boot
          echo "CONFIG_SECURITY_SELINUX_DISABLE=y" >> $CONF
          echo "CONFIG_SECURITY_SELINUX_BOOTPARAM=y" >> $CONF
          echo "CONFIG_DEBUG_SECTION_MISMATCH=y" >> $CONF

      - name: Build Kernel
        run: |
          cd kernel-source
          export PATH="${{ env.CLANG_DIR }}/bin:$PATH"
          export ARCH=arm64
          export SUBARCH=arm64
          export KBUILD_COMPILER_STRING="$(clang --version | head -n 1)"
          
          # Tao file config
          make O=out ARCH=arm64 viva_defconfig
          
          # Bat dau build
          make -j$(nproc --all) O=out ARCH=arm64 CC=clang CROSS_COMPILE=aarch64-linux-gnu- CROSS_COMPILE_ARM32=arm-linux-gnueabi- Image.gz-dtb

      - name: Upload Kernel Image
        uses: actions/upload-artifact@v4
        with:
          name: Viva-A16-KernelSU-Next-Image
          path: kernel-source/out/arch/arm64/boot/Image.gz-dtb
